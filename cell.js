'use strict';

function Cell(name, fnText, accDefault) {
    this.giveName(name);
    this.subscribers = [];
    this.upstreams = {};
    this.update(fnText || 'undefined', undefined, accDefault);
}

Cell.prototype.update = function update(fnText, name, accDefault) {

    var self = this;

    if (name !== undefined) {
        self.giveName(name);
    }

    if (accDefault !== undefined) {
        self.accText = accDefault || 'undefined';
        self.accDefault = Parser.createCalc(accDefault);
        self.acc = self.accDefault(self, {}, self.acc); //eval the function/string and use this function
    }

    if (fnText !== undefined) {
        self.fnText = fnText;

        //subscribe to upstreams
        var self = self;
        Parser.classifyTokens(fnText).refs.forEach(function (ref) {
            self.subUpstream(ref);
        });

        //create fn
        self.fn = Parser.createCalc(fnText);
    }

    //generate context
    //upstream looks like this:
    //cellTo.upstreams[cellFrom.name] = { from: cellFrom, bridgeFunc: bridgeFunc };
    var ctx = {};
    for (var prop in self.upstreams) {
        if (self.upstreams.hasOwnProperty(prop)) {
            ctx[prop] = self.upstreams[prop].from.output;
        }
    }

    var _result = self.fn(self, ctx, self.acc);

    if (_result && _result.then) {
        _result.then(function (val) {
            self.output = val;
            self.acc = self.output !== undefined ? self.output : self.acc;
            self.notify();
        })['catch'](function (ex) {
            console.log('error from calculation: ', ex);
        });
    } else {
        self.output = _result;
        self.acc = self.output !== undefined ? self.output : self.acc;
        self.notify();
    }
};

Cell.prototype.resetAcc = function resetAcc() {
    this.update(undefined, undefined, this.accText);
};

Cell.names = {};
Cell.anonNameCount = 0;

Cell.getCell = function getCell(name) {
    return Cell.names[name];
};

Cell.prototype.giveName = function giveName(name) {
    var _n = name || undefined;

    if (name === undefined) {
        Cell.anonNameCount++;
        _n = 'anon' + Cell.anonNameCount;
    }

    if (Cell.names[_n] === undefined) {
        Cell.names[_n] = this;
        this.name = _n;
    } else {
        throw new Error('Cell with a name "' + _n + '" already exists.  Please choose another');
    }
};

Cell.prototype.notify = function notify() {
    var self = this;

    this.subscribers.forEach(function (sub) {
        try {
            sub(self);
        } catch (err) {
            console.log(err);
        }
    });
};

Cell.prototype.subscribe = function subscribe(watch) {
    this.subscribers.push(watch);
};

Cell.prototype.unsubscribe = function unsubscribe(watch) {
    var idx = this.subscribers.indexOf(watch);
    if (idx > -1) {
        this.subscribers.splice(idx, 1);
    }
};

Cell.link = function link(cellFrom, cellTo) {
    var bridgeFunc = function bridgeFunc() {
        cellTo.update();
    };
    cellTo.upstreams[cellFrom.name] = { from: cellFrom, bridgeFunc: bridgeFunc };
    cellFrom.subscribe(bridgeFunc);
};

Cell.unlink = function unlink(cellFrom, cellTo) {
    cellFrom.unsubscribe(cellTo.upstreams[cellFrom.name].bridgeFunc);
    delete cellTo.upstreams[cellFrom.name];
};

Cell.prototype.subUpstream = function subUpstream(name) {
    if (this.upstreams[name] === undefined && Cell.getCell(name) !== undefined) {
        //otherwise, we are already subscribed
        Cell.link(Cell.getCell(name), this);
    }
};
//# sourceMappingURL=data:application/json;base64,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QyxNQUFNLEdBQUcsU0FBUyxNQUFNLENBQUMsUUFBUSxFQUFDLE1BQU0sRUFBQztBQUMxQyxZQUFRLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ2pFLFdBQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7Q0FDMUMsQ0FBQzs7QUFFRixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsR0FBRyxTQUFTLFdBQVcsQ0FBQyxJQUFJLEVBQUM7QUFDbkQsUUFBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLFNBQVMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLFNBQVMsRUFBQzs7QUFDdEUsWUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3RDO0NBQ0osQ0FBQyIsImZpbGUiOiJzcmMvY2VsbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImZ1bmN0aW9uIENlbGwobmFtZSxmblRleHQsYWNjRGVmYXVsdCl7XG4gICAgdGhpcy5naXZlTmFtZShuYW1lKTtcbiAgICB0aGlzLnN1YnNjcmliZXJzID0gW107XG4gICAgdGhpcy51cHN0cmVhbXMgPSB7fTtcbiAgICB0aGlzLnVwZGF0ZShmblRleHQgfHwgJ3VuZGVmaW5lZCcsdW5kZWZpbmVkLGFjY0RlZmF1bHQpO1xufVxuXG5DZWxsLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoZm5UZXh0LG5hbWUsYWNjRGVmYXVsdCl7XG5cbiAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICBpZihuYW1lICE9PSB1bmRlZmluZWQpe1xuICAgICAgICBzZWxmLmdpdmVOYW1lKG5hbWUpO1xuICAgIH1cblxuICAgIGlmKGFjY0RlZmF1bHQgIT09IHVuZGVmaW5lZCl7XG4gICAgICAgIHNlbGYuYWNjVGV4dCA9IGFjY0RlZmF1bHQgfHwgJ3VuZGVmaW5lZCc7XG4gICAgICAgIHNlbGYuYWNjRGVmYXVsdCA9IFBhcnNlci5jcmVhdGVDYWxjKGFjY0RlZmF1bHQpO1xuICAgICAgICBzZWxmLmFjYyA9IHNlbGYuYWNjRGVmYXVsdChzZWxmLHt9LCBzZWxmLmFjYyk7Ly9ldmFsIHRoZSBmdW5jdGlvbi9zdHJpbmcgYW5kIHVzZSB0aGlzIGZ1bmN0aW9uXG4gICAgfVxuXG4gICAgaWYoZm5UZXh0ICE9PSB1bmRlZmluZWQpe1xuICAgICAgICBzZWxmLmZuVGV4dCA9IGZuVGV4dDtcblxuICAgICAgICAvL3N1YnNjcmliZSB0byB1cHN0cmVhbXNcbiAgICAgICAgdmFyIHNlbGYgPSBzZWxmO1xuICAgICAgICBQYXJzZXIuY2xhc3NpZnlUb2tlbnMoZm5UZXh0KS5yZWZzLmZvckVhY2goZnVuY3Rpb24ocmVmKXtcbiAgICAgICAgICAgIHNlbGYuc3ViVXBzdHJlYW0ocmVmKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9jcmVhdGUgZm5cbiAgICAgICAgc2VsZi5mbiA9IFBhcnNlci5jcmVhdGVDYWxjKGZuVGV4dCk7XG4gICAgfVxuXG4gICAgLy9nZW5lcmF0ZSBjb250ZXh0XG4gICAgLy91cHN0cmVhbSBsb29rcyBsaWtlIHRoaXM6XG4gICAgLy9jZWxsVG8udXBzdHJlYW1zW2NlbGxGcm9tLm5hbWVdID0geyBmcm9tOiBjZWxsRnJvbSwgYnJpZGdlRnVuYzogYnJpZGdlRnVuYyB9O1xuICAgIHZhciBjdHggPSB7fTtcbiAgICBmb3IodmFyIHByb3AgaW4gc2VsZi51cHN0cmVhbXMpe1xuICAgICAgICBpZihzZWxmLnVwc3RyZWFtcy5oYXNPd25Qcm9wZXJ0eShwcm9wKSl7XG4gICAgICAgICAgICBjdHhbcHJvcF0gPSBzZWxmLnVwc3RyZWFtc1twcm9wXS5mcm9tLm91dHB1dDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHZhciBfcmVzdWx0ID0gc2VsZi5mbihzZWxmLCBjdHgsIHNlbGYuYWNjKTtcblxuICAgIGlmKF9yZXN1bHQgJiYgX3Jlc3VsdC50aGVuKXtcbiAgICAgICAgX3Jlc3VsdFxuICAgICAgICAudGhlbihmdW5jdGlvbih2YWwpe1xuICAgICAgICAgICAgc2VsZi5vdXRwdXQgPSB2YWw7XG4gICAgICAgICAgICBzZWxmLmFjYyA9IHNlbGYub3V0cHV0ICE9PSB1bmRlZmluZWQgPyBzZWxmLm91dHB1dCA6IHNlbGYuYWNjO1xuICAgICAgICAgICAgc2VsZi5ub3RpZnkoKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGV4KSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgZnJvbSBjYWxjdWxhdGlvbjogJywgZXgpO1xuICAgICAgICB9KTtcbiAgICB9ZWxzZXtcbiAgICAgICAgc2VsZi5vdXRwdXQgPSBfcmVzdWx0O1xuICAgICAgICBzZWxmLmFjYyA9IHNlbGYub3V0cHV0ICE9PSB1bmRlZmluZWQgPyBzZWxmLm91dHB1dCA6IHNlbGYuYWNjO1xuICAgICAgICBzZWxmLm5vdGlmeSgpO1xuICAgIH1cblxufTtcblxuQ2VsbC5wcm90b3R5cGUucmVzZXRBY2MgPSBmdW5jdGlvbiByZXNldEFjYygpe1xuICAgIHRoaXMudXBkYXRlKHVuZGVmaW5lZCx1bmRlZmluZWQsdGhpcy5hY2NUZXh0KTtcbn07XG5cbkNlbGwubmFtZXMgPSB7fTtcbkNlbGwuYW5vbk5hbWVDb3VudCA9IDA7XG5cbkNlbGwuZ2V0Q2VsbCA9IGZ1bmN0aW9uIGdldENlbGwobmFtZSl7XG4gICAgcmV0dXJuIENlbGwubmFtZXNbbmFtZV07XG59O1xuXG5DZWxsLnByb3RvdHlwZS5naXZlTmFtZSA9IGZ1bmN0aW9uIGdpdmVOYW1lKG5hbWUpe1xuICAgIHZhciBfbiA9IG5hbWUgfHwgdW5kZWZpbmVkO1xuXG4gICAgaWYobmFtZSA9PT0gdW5kZWZpbmVkKXtcbiAgICAgICAgQ2VsbC5hbm9uTmFtZUNvdW50Kys7XG4gICAgICAgIF9uID0gXCJhbm9uXCIgKyBDZWxsLmFub25OYW1lQ291bnQ7XG4gICAgfVxuXG4gICAgaWYoQ2VsbC5uYW1lc1tfbl0gPT09IHVuZGVmaW5lZCl7XG4gICAgICAgIENlbGwubmFtZXNbX25dID0gdGhpcztcbiAgICAgICAgdGhpcy5uYW1lID0gX247XG4gICAgfWVsc2V7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ2VsbCB3aXRoIGEgbmFtZSBcIicgKyBfbiArICdcIiBhbHJlYWR5IGV4aXN0cy4gIFBsZWFzZSBjaG9vc2UgYW5vdGhlcicpO1xuICAgIH1cbn07XG5cbkNlbGwucHJvdG90eXBlLm5vdGlmeSA9IGZ1bmN0aW9uIG5vdGlmeSgpe1xuICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgIHRoaXMuc3Vic2NyaWJlcnMuZm9yRWFjaChmdW5jdGlvbihzdWIpe1xuICAgICAgICB0cnl7XG4gICAgICAgICAgICBzdWIoc2VsZik7XG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgfVxuICAgIH0pO1xufTtcblxuQ2VsbC5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gc3Vic2NyaWJlKHdhdGNoKXtcbiAgICB0aGlzLnN1YnNjcmliZXJzLnB1c2god2F0Y2gpO1xufTtcblxuQ2VsbC5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiB1bnN1YnNjcmliZSh3YXRjaCl7XG4gICAgdmFyIGlkeCA9IHRoaXMuc3Vic2NyaWJlcnMuaW5kZXhPZih3YXRjaCk7XG4gICAgaWYoaWR4ID4gLTEpe1xuICAgICAgICB0aGlzLnN1YnNjcmliZXJzLnNwbGljZShpZHgsMSk7XG4gICAgfVxufTtcblxuQ2VsbC5saW5rID0gZnVuY3Rpb24gbGluayhjZWxsRnJvbSxjZWxsVG8pe1xuICAgIHZhciBicmlkZ2VGdW5jID0gZnVuY3Rpb24gYnJpZGdlRnVuYygpe1xuICAgICAgICBjZWxsVG8udXBkYXRlKCk7XG4gICAgfTtcbiAgICBjZWxsVG8udXBzdHJlYW1zW2NlbGxGcm9tLm5hbWVdID0geyBmcm9tOiBjZWxsRnJvbSwgYnJpZGdlRnVuYzogYnJpZGdlRnVuYyB9O1xuICAgIGNlbGxGcm9tLnN1YnNjcmliZShicmlkZ2VGdW5jKTtcbn07XG5cbkNlbGwudW5saW5rID0gZnVuY3Rpb24gdW5saW5rKGNlbGxGcm9tLGNlbGxUbyl7XG4gICAgY2VsbEZyb20udW5zdWJzY3JpYmUoY2VsbFRvLnVwc3RyZWFtc1tjZWxsRnJvbS5uYW1lXS5icmlkZ2VGdW5jKTtcbiAgICBkZWxldGUgY2VsbFRvLnVwc3RyZWFtc1tjZWxsRnJvbS5uYW1lXTtcbn07XG5cbkNlbGwucHJvdG90eXBlLnN1YlVwc3RyZWFtID0gZnVuY3Rpb24gc3ViVXBzdHJlYW0obmFtZSl7XG4gICAgaWYodGhpcy51cHN0cmVhbXNbbmFtZV0gPT09IHVuZGVmaW5lZCAmJiBDZWxsLmdldENlbGwobmFtZSkgIT09IHVuZGVmaW5lZCl7Ly9vdGhlcndpc2UsIHdlIGFyZSBhbHJlYWR5IHN1YnNjcmliZWRcbiAgICAgICAgQ2VsbC5saW5rKENlbGwuZ2V0Q2VsbChuYW1lKSx0aGlzKTtcbiAgICB9XG59O1xuIl19